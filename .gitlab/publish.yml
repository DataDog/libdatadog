# Publish crate to crates.io
publish_crates:
  tags: ["arch:amd64"]
  image: registry.ddbuild.io/images/base/ubuntu_2204:latest
  resource_group: publish-${CI_COMMIT_TAG}
  stage: publish
  rules:
    - if: '$CI_COMMIT_TAG'
      when: manual
  variables:
    DRY_RUN:
      value: "true"
      description: "Perform dry-run only (true) or actually publish to crates.io (false)"
      options:
        - "true"
        - "false"
  script:
    - echo "=========================================="
    - echo "‚ö†Ô∏è  PUBLICATION CONFIRMATION"
    - echo "=========================================="
    - echo ""
    - echo "Tag to publish: $CI_COMMIT_TAG"
    - echo ""
    - |
      if [ "$DRY_RUN" = "true" ]; then
        echo "üîµ MODE: DRY-RUN (no actual publication)"
        echo "   Crate will be validated but NOT published to crates.io"
      else
        echo "üî¥ MODE: ACTUAL PUBLICATION"
        echo "   Crate WILL be published to crates.io"
      fi
    - echo ""
    - echo "‚úì Proceeding with publication..."
    - echo ""
    - echo "=== Setting up environment for publication ==="
    - |
      # Install build-essential and curl jq, etc
      apt-get update && apt-get install -y build-essential curl jq git golang-go cmake

      # Install rustup and set it to stable
      curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
      source $HOME/.cargo/env
      rustup install stable
      rustup default stable
      
      echo ""
      echo "=== Running publication script ==="
      
      # Build command based on DRY_RUN setting
      if [ "$DRY_RUN" = "true" ]; then
        echo "üîµ Running in DRY-RUN mode"
        ./scripts/publish-crates.sh --dry-run --token "${CARGO_REGISTRY_TOKEN:-test}" "$CI_COMMIT_TAG"
      else
        echo "üî¥ Running in ACTUAL PUBLICATION mode"
        ./scripts/publish-crates.sh --token "$CARGO_REGISTRY_TOKEN" "$CI_COMMIT_TAG"
      fi

variables:
  # Configurable branch where tags should trigger this workflow
  TARGET_BRANCH:
    value: "main"
    description: "Only tags on this branch will trigger the release workflow"

# Detect all tags on this commit
detect_tags:
  tags: ["arch:amd64"]
  image: registry.ddbuild.io/images/base/ubuntu_2204:latest
  stage: publish
  # Ensure only one pipeline runs at a time for this commit because it handles multiple tags
  resource_group: publish-${CI_COMMIT_SHA}
  rules:
    # - if: '$CI_COMMIT_TAG && $CI_COMMIT_BRANCH == $TARGET_BRANCH'
    - if: '$CI_COMMIT_TAG'
      when: on_success
  script:
    - echo "=== Detecting tags on commit $CI_COMMIT_SHA ==="
    - |
      # Install git and curl
      apt-get update && apt-get install -y git curl jq

      # Check if there's already another pipeline for this commit (excluding canceled/failed)
      echo "Checking for other pipelines on this commit..."
      
      RESPONSE=$(curl -s --header "JOB-TOKEN: $CI_JOB_TOKEN" \
        "$CI_API_V4_URL/projects/$CI_PROJECT_ID/pipelines?sha=$CI_COMMIT_SHA")
      
      # Verify we got a valid JSON array response
      if ! echo "$RESPONSE" | jq -e 'type == "array"' > /dev/null 2>&1; then
        echo "Warning: Could not fetch pipelines from API (may not have permissions)"
        echo "Proceeding with tag detection..."
      else
        ALL_PIPELINES=$(echo "$RESPONSE" | jq -r '[.[] | select(.status != "canceled" and .status != "failed")] | .[].id' 2>/dev/null || echo "")
        
        if [ -z "$ALL_PIPELINES" ]; then
          PIPELINE_COUNT=0
        else
          PIPELINE_COUNT=$(echo "$ALL_PIPELINES" | wc -l)
        fi
        
        echo "Found $PIPELINE_COUNT active pipeline(s) for this commit"
        
        # If there are multiple pipelines and ours is not the first one, exit
        if [ "$PIPELINE_COUNT" -gt 1 ]; then
          FIRST_PIPELINE=$(echo "$ALL_PIPELINES" | head -1)
          if [ "$CI_PIPELINE_ID" != "$FIRST_PIPELINE" ]; then
            echo "Pipeline $FIRST_PIPELINE is already handling tags for this commit."
            echo "This pipeline ($CI_PIPELINE_ID) is redundant. Exiting gracefully..."
            
            # Create empty artifacts so downstream jobs don't fail
            echo "" > tags.txt
            echo "DETECTED_TAGS=" > tags.env
            exit 0
          fi
        fi
        
        echo "This pipeline will handle all tags for commit $CI_COMMIT_SHA"
      fi

      # Fetch all tags from remote (GitLab CI uses shallow clones)
      git fetch --tags
      
      # Get all tags pointing to this commit
      TAGS=$(git tag --points-at HEAD)
      
      if [ -z "$TAGS" ]; then
        echo "No tags found on this commit"
        exit 1
      fi
      
      echo "Found tags:"
      echo "$TAGS"
      echo ""
      
      # Save tags for next stages
      echo "$TAGS" > tags.txt
      
      # Save tags as space-separated for env variable (dotenv format requires single line)
      TAGS_SPACE_SEPARATED=$(echo "$TAGS" | tr '\n' ' ' | sed 's/ $//')
      echo "DETECTED_TAGS=$TAGS_SPACE_SEPARATED" > tags.env
  artifacts:
    reports:
      dotenv: tags.env
    paths:
      - tags.txt
    expire_in: 1 day

# Manual confirmation step - review tags before publishing
confirm_publication:
  tags: ["arch:amd64"]
  image: registry.ddbuild.io/images/base/ubuntu_2204:latest
  stage: publish
  resource_group: publish-${CI_COMMIT_SHA}
  needs:
    - detect_tags
  rules:
    - if: '$CI_COMMIT_TAG'
      when: manual
  script:
    - |
      # Check if this is a redundant pipeline
      if [ ! -s tags.txt ]; then
        echo "No tags to publish - this pipeline was skipped (redundant)"
        exit 0
      fi
      
      echo "=== Manual Confirmation Required ==="
      echo "The publish script will validate and sort the following tags:"
      cat tags.txt
      echo ""
      echo "âœ“ Manual approval granted - proceeding with publication"
  artifacts:
    reports:
      dotenv: tags.env
    paths:
      - tags.txt
    expire_in: 1 day
  allow_failure: false

# Publish crates sequentially using the publish script
publish_crates:
  tags: ["arch:amd64"]
  image: registry.ddbuild.io/images/base/ubuntu_2204:latest
  resource_group: publish-${CI_COMMIT_SHA}
  needs:
    - confirm_publication
  stage: publish
  rules:
    # - if: '$CI_COMMIT_TAG && $CI_COMMIT_BRANCH == $TARGET_BRANCH'
    - if: '$CI_COMMIT_TAG'
      when: on_success
  script:
    - |
      # Check if this is a redundant pipeline
      if [ ! -s tags.txt ]; then
        echo "No tags to publish - this pipeline was skipped (redundant)"
        exit 0
      fi
      
      echo "=== Setting up environment for publication ==="
      
      # Install build-essential and curl
      apt-get update && apt-get install -y build-essential curl jq git

      # Install rustup and set it to stable
      curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
      source $HOME/.cargo/env
      rustup install stable
      rustup default stable
      
      echo ""
      echo "=== Running publication script ==="
      
      # Read tags and call the publish script
      TAGS=$(cat tags.txt)
      
      # For now, use --dry-run. Remove it to actually publish
      ./scripts/publish-crates.sh --dry-run --token "${CARGO_REGISTRY_TOKEN:-test}" $TAGS

name: 'Verify trace-protobuf'
on:
  pull_request:
    types: [ opened, synchronize, reopened ]

env:
  DATADOG_AGENT_TAG: "7.53.0-rc.1"

jobs:
  verify-proto-files:
    name: "Verify trace-protobuf .proto files are in sync with datadog-agent"
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - name: Checkout sources
        uses: actions/checkout@v4
      - name: diff agent_payload.proto
        working-directory: trace-protobuf/src/pb
        run: |
          ../../../.github/workflows/diff-proto-files.sh --file agent_payload.proto --tag ${{ env.DATADOG_AGENT_TAG }}
      - name: diff tracer_payload.proto
        if: success() || failure()
        working-directory: trace-protobuf/src/pb
        run: |
          ../../../.github/workflows/diff-proto-files.sh --file tracer_payload.proto --tag ${{ env.DATADOG_AGENT_TAG }}
      - name: diff stats.proto
        if: success() || failure()
        working-directory: trace-protobuf/src/pb
        run: |
          ../../../.github/workflows/diff-proto-files.sh --file stats.proto --tag ${{ env.DATADOG_AGENT_TAG }}
      - name: diff span.proto
        if: success() || failure()
        working-directory: trace-protobuf/src/pb
        run: |
          ../../../.github/workflows/diff-proto-files.sh --file span.proto --tag ${{ env.DATADOG_AGENT_TAG }}
